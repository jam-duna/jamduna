<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OP Code Analysis Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap" rel="stylesheet">
    <style>
        /* Base styles */
        body {
            font-family: "Inter", sans-serif;
            background-color: #f0f2f5;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 20px;
        }
        .container {
            background-color: #ffffff;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 1600px; /* Increased for new column */
            margin-top: 20px;
        }
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        .header h1 {
            font-size: 2.5rem;
            font-weight: bold;
            color: #333;
        }
        .header p {
            color: #666;
            font-size: 1rem;
        }

        /* Upload and Filter sections */
        .upload-section, .filter-options {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        input[type="file"] { display: none; }
        .action-btn {
            color: white;
            padding: 12px 25px;
            border-radius: 10px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        .custom-file-upload { 
            background-color: #edf2f7; 
            color: #4299e1; 
            border: 2px dashed #a0aec0; 
            box-shadow: none;
        }
        .custom-file-upload:hover { 
            border-color: #4299e1; 
            background-color: #e2e8f0; 
        }
        .paste-json-button {
             background-color: #63b3ed;
             box-shadow: 0 4px 10px rgba(99, 179, 237, 0.3);
        }
        .paste-json-button:hover { 
            background-color: #4299e1; 
            transform: translateY(-2px); 
        }
        .clear-data-button {
            background-color: #fca5a5;
            color: #991b1b;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.2);
        }
        .clear-data-button:hover {
            background-color: #ef4444;
            color: white;
            transform: translateY(-2px);
        }
        .file-name { font-style: italic; color: #555; }
        .filter-options input {
            padding: 10px 15px;
            border: 1px solid #cbd5e0;
            border-radius: 10px;
            font-size: 1rem;
        }
        .filter-options .button-group { display: flex; gap: 10px; }
        .control-button {
            background-color: #4299e1;
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .control-button:hover { background-color: #3182ce; transform: translateY(-1px); }
        .control-button.active { background-color: #dd6b20; }
        .clear-filter-button { background-color: #e53e3e; }
        .clear-filter-button:hover { background-color: #c53030; }
        .export-button { background-color: #48bb78; }
        .export-button:hover { background-color: #38a169; }

        /* Summary Cards */
        .summary-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .summary-card {
            background-color: #f7fafc;
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #4299e1;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        }
        .summary-card h3 { color: #4a5568; font-size: 1rem; margin-bottom: 5px; }
        .summary-card p { color: #2d3748; font-size: 1.8rem; font-weight: bold; }

        /* Chart Section */
        .chart-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }
        .chart-card h3 { font-size: 1.5rem; text-align: center; margin-bottom: 15px; color: #333; }
        .bar-chart .bar { cursor: pointer; transition: fill 0.2s ease; }
        .bar-chart .bar:hover { fill: #fdba74; }
        .bar-chart .axis-x path, .bar-chart .axis-y path { display: none; }
        .bar-chart .tick line { stroke: #e2e8f0; }
        .bar-chart .tick text { fill: #4a5568; }

        /* Table Section */
        .table-controls { display: flex; justify-content: flex-end; align-items: center; gap: 10px; margin-bottom: 10px; flex-wrap: wrap;}
        #normalizationControls { display: flex; align-items: center; gap: 10px; }
        #normalizationFactorSelect {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: #edf2f7;
            border: 1px solid #cbd5e0;
            border-radius: 10px;
            padding: 10px 20px;
            font-size: 0.95rem;
            font-weight: 600;
            color: #4a5568;
            cursor: pointer;
        }

        .results-table { width: 100%; border-collapse: collapse; }
        .results-table th, .results-table td { padding: 12px 15px; text-align: left; border-bottom: 1px solid #e2e8f0; white-space: nowrap; }
        .results-table th { background-color: #edf2f7; color: #4a5568; font-weight: 700; text-transform: uppercase; font-size: 0.8rem; cursor: pointer; }
        .results-table th.sorted-asc::after { content: ' ▲'; }
        .results-table th.sorted-desc::after { content: ' ▼'; }
        .results-table tr.pvm-row.striped-row, .results-table tr.family-row.striped-row { background-color: #f9fafb; }
        .results-table tr.pvm-row:hover, .results-table tr.family-row:hover { background-color: #ebf8ff; }
        .results-table tr.family-row { font-weight: bold; background-color: #f0f9ff; }
        .results-table tr.pvm-sub-row { background-color: #fafcff; }
        .results-table tr.x86-detail-row { background-color: #fdfdff; font-size: 0.9rem; color: #4a5568; }
        .results-table tr.hidden { display: none; }
        .results-table .toggle-icon { margin-right: 8px; display: inline-block; width: 16px; text-align: center; cursor: pointer; user-select: none; font-weight: bold; color: #4299e1; }

        /* Modal for Pasting JSON */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6); display: flex;
            justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-content {
            background-color: white; padding: 30px; border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3); width: 90%; max-width: 600px;
            display: flex; flex-direction: column; gap: 20px;
        }
        #jsonPasteArea {
            width: 100%; height: 300px; padding: 15px; border: 1px solid #cbd5e0;
            border-radius: 10px; font-size: 0.9rem; resize: vertical;
        }
        
        /* Utility classes */
        .hidden { display: none !important; }
        .error-message { color: #e53e3e; background-color: #fed7d7; padding: 15px; border-radius: 10px; margin-top: 20px; text-align: center; font-weight: 600; }
        #loadingSpinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; margin: 40px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>PVM OP Code Analysis Dashboard</h1>
            <p>Upload, paste, or load from a previous session to analyze PVM operations.</p>
        </div>

        <div class="upload-section">
            <label for="jsonFile" class="action-btn custom-file-upload">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                <span>Upload JSON</span>
            </label>
            <input type="file" id="jsonFile" accept=".json">
            <button id="pasteJsonButton" class="action-btn paste-json-button">Paste JSON</button>
            <button id="clearDataButton" class="action-btn clear-data-button hidden">Clear Data</button>
            <p id="fileNameDisplay" class="file-name"></p>
        </div>
        <div id="errorMessage" class="error-message hidden"></div>

        <div class="analysis-section hidden" id="analysisSection">
            <div class="filter-options">
                <label for="searchPVM">Search Op / Family:</label>
                <input type="text" id="searchPVM" placeholder="e.g., ADD_64 or BinaryOp">
                <label for="filterPVMCount">PVM Insts > :</label>
                <input type="number" id="filterPVMCount" placeholder="e.g., 1000">
                <div class="button-group">
                    <button id="clearFilters" class="control-button clear-filter-button">Clear Filters</button>
                    <button id="exportCsvButton" class="control-button export-button">Export CSV</button>
                    <button id="exportJsonButton" class="control-button export-button">Export JSON</button>
                </div>
            </div>
        </div>

        <div id="loadingSpinner" class="hidden"></div>

        <div class="results-section hidden" id="resultsSection">
            <div id="summarySection" class="summary-container"></div>
            <div id="chartSection" class="chart-container"></div>
            <div class="table-controls">
                <div id="normalizationControls" class="hidden">
                    <label for="normalizationFactorSelect" class="text-sm font-semibold text-gray-600">Normalize by:</label>
                    <select id="normalizationFactorSelect">
                        <option value="executionCount">Execution Count</option>
                        <option value="totalPvmInsts">Total PVM Insts</option>
                    </select>
                </div>
                <button id="groupByFamilyButton" class="control-button">Group by Family</button>
                <button id="normalizeButton" class="control-button">Normalize</button>
                <button id="expandAll" class="control-button">Expand All</button>
                <button id="collapseAll" class="control-button">Collapse All</button>
            </div>
            <table class="results-table">
                <thead id="resultsTableHead">
                    <!-- Header will be rendered dynamically -->
                </thead>
                <tbody id="resultsTableBody"></tbody>
            </table>
            <p id="table-empty-state" class="hidden error-message" style="background-color: #ebf8ff; color: #3182ce;">No operations match the current filters.</p>
        </div>

        <div id="jsonModal" class="modal-overlay hidden">
            <div class="modal-content">
                <h3>Paste JSON Data</h3>
                <textarea id="jsonPasteArea" placeholder="Paste your JSON data here..." style="font-family: monospace;"></textarea>
                <div id="modalErrorMessage" class="error-message hidden"></div>
                <div style="display: flex; justify-content: flex-end; gap: 15px;">
                    <button id="processPastedJson" class="control-button export-button">Process</button>
                    <button id="closeModal" class="control-button clear-filter-button">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE MANAGEMENT ---
            let allData = [];
            let displayedData = [];
            let currentSort = { column: 'weightedX86Insts', direction: 'desc' };
            let isNormalized = false;
            let isGroupedByFamily = false;
            let normalizationFactor = 'executionCount';
            let expandedRows = new Set();

            // --- DOM ELEMENT CACHE ---
            const dom = {
                jsonFile: document.getElementById('jsonFile'),
                fileNameDisplay: document.getElementById('fileNameDisplay'),
                pasteJsonButton: document.getElementById('pasteJsonButton'),
                clearDataButton: document.getElementById('clearDataButton'),
                errorMessage: document.getElementById('errorMessage'),
                analysisSection: document.getElementById('analysisSection'),
                resultsSection: document.getElementById('resultsSection'),
                loadingSpinner: document.getElementById('loadingSpinner'),
                searchPVM: document.getElementById('searchPVM'),
                filterPVMCount: document.getElementById('filterPVMCount'),
                clearFilters: document.getElementById('clearFilters'),
                exportCsv: document.getElementById('exportCsvButton'),
                exportJson: document.getElementById('exportJsonButton'),
                summarySection: document.getElementById('summarySection'),
                chartSection: document.getElementById('chartSection'),
                tableBody: document.getElementById('resultsTableBody'),
                tableHead: document.getElementById('resultsTableHead'),
                tableEmptyState: document.getElementById('table-empty-state'),
                expandAll: document.getElementById('expandAll'),
                collapseAll: document.getElementById('collapseAll'),
                normalizeButton: document.getElementById('normalizeButton'),
                groupByFamilyButton: document.getElementById('groupByFamilyButton'),
                normalizationControls: document.getElementById('normalizationControls'),
                normalizationFactorSelect: document.getElementById('normalizationFactorSelect'),
                jsonModal: document.getElementById('jsonModal'),
                jsonPasteArea: document.getElementById('jsonPasteArea'),
                processPastedJson: document.getElementById('processPastedJson'),
                closeModal: document.getElementById('closeModal'),
                modalErrorMessage: document.getElementById('modalErrorMessage'),
            };

            // --- CONSTANTS ---
            const pvmOpToOpcodeMap = { "TRAP": 0, "FALLTHROUGH": 1, "ECALLI": 10, "LOAD_IMM_64": 20, "STORE_IMM_U8": 30, "STORE_IMM_U16": 31, "STORE_IMM_U32": 32, "STORE_IMM_U64": 33, "JUMP": 40, "JUMP_IND": 50, "LOAD_IMM": 51, "LOAD_U8": 52, "LOAD_I8": 53, "LOAD_U16": 54, "LOAD_I16": 55, "LOAD_U32": 56, "LOAD_I32": 57, "LOAD_U64": 58, "STORE_U8": 59, "STORE_U16": 60, "STORE_U32": 61, "STORE_U64": 62, "STORE_IMM_IND_U8": 70, "STORE_IMM_IND_U16": 71, "STORE_IMM_IND_U32": 72, "STORE_IMM_IND_U64": 73, "LOAD_IMM_JUMP": 80, "BRANCH_EQ_IMM": 81, "BRANCH_NE_IMM": 82, "BRANCH_LT_U_IMM": 83, "BRANCH_LE_U_IMM": 84, "BRANCH_GE_U_IMM": 85, "BRANCH_GT_U_IMM": 86, "BRANCH_LT_S_IMM": 87, "BRANCH_LE_S_IMM": 88, "BRANCH_GE_S_IMM": 89, "BRANCH_GT_S_IMM": 90, "MOVE_REG": 100, "SBRK": 101, "COUNT_SET_BITS_64": 102, "COUNT_SET_BITS_32": 103, "LEADING_ZERO_BITS_64": 104, "LEADING_ZERO_BITS_32": 105, "TRAILING_ZERO_BITS_64": 106, "TRAILING_ZERO_BITS_32": 107, "SIGN_EXTEND_8": 108, "SIGN_EXTEND_16": 109, "ZERO_EXTEND_16": 110, "REVERSE_BYTES": 111, "STORE_IND_U8": 120, "STORE_IND_U16": 121, "STORE_IND_U32": 122, "STORE_IND_U64": 123, "LOAD_IND_U8": 124, "LOAD_IND_I8": 125, "LOAD_IND_U16": 126, "LOAD_IND_I16": 127, "LOAD_IND_U32": 128, "LOAD_IND_I32": 129, "LOAD_IND_U64": 130, "ADD_IMM_32": 131, "AND_IMM": 132, "XOR_IMM": 133, "OR_IMM": 134, "MUL_IMM_32": 135, "SET_LT_U_IMM": 136, "SET_LT_S_IMM": 137, "SHLO_L_IMM_32": 138, "SHLO_R_IMM_32": 139, "SHAR_R_IMM_32": 140, "NEG_ADD_IMM_32": 141, "SET_GT_U_IMM": 142, "SET_GT_S_IMM": 143, "SHLO_L_IMM_ALT_32": 144, "SHLO_R_IMM_ALT_32": 145, "SHAR_R_IMM_ALT_32": 146, "CMOV_IZ_IMM": 147, "CMOV_NZ_IMM": 148, "ADD_IMM_64": 149, "MUL_IMM_64": 150, "SHLO_L_IMM_64": 151, "SHLO_R_IMM_64": 152, "SHAR_R_IMM_64": 153, "NEG_ADD_IMM_64": 154, "SHLO_L_IMM_ALT_64": 155, "SHLO_R_IMM_ALT_64": 156, "SHAR_R_IMM_ALT_64": 157, "ROT_R_64_IMM": 158, "ROT_R_64_IMM_ALT": 159, "ROT_R_32_IMM": 160, "ROT_R_32_IMM_ALT": 161, "BRANCH_EQ": 170, "BRANCH_NE": 171, "BRANCH_LT_U": 172, "BRANCH_LT_S": 173, "BRANCH_GE_U": 174, "BRANCH_GE_S": 175, "LOAD_IMM_JUMP_IND": 180, "ADD_32": 190, "SUB_32": 191, "MUL_32": 192, "DIV_U_32": 193, "DIV_S_32": 194, "REM_U_32": 195, "REM_S_32": 196, "SHLO_L_32": 197, "SHLO_R_32": 198, "SHAR_R_32": 199, "ADD_64": 200, "SUB_64": 201, "MUL_64": 202, "DIV_U_64": 203, "DIV_S_64": 204, "REM_U_64": 205, "REM_S_64": 206, "SHLO_L_64": 207, "SHLO_R_64": 208, "SHAR_R_64": 209, "AND": 210, "XOR": 211, "OR": 212, "MUL_UPPER_S_S": 213, "MUL_UPPER_U_U": 214, "MUL_UPPER_S_U": 215, "SET_LT_U": 216, "SET_LT_S": 217, "CMOV_IZ": 218, "CMOV_NZ": 219, "ROT_L_64": 220, "ROT_L_32": 221, "ROT_R_64": 222, "ROT_R_32": 223, "AND_INV": 224, "OR_INV": 225, "XNOR": 226, "MAX": 227, "MAX_U": 228, "MIN": 229, "MIN_U": 230 };
            const pvmOpToFamilyMap = {'TRAP':'Trap','FALLTHROUGH':'Fallthrough','JUMP':'Jump','LOAD_IMM_JUMP':'LoadImmJump','JUMP_IND':'JumpIndirect','LOAD_IMM_JUMP_IND':'LoadImmJumpIndirect','BRANCH_EQ_IMM':'BranchImm','BRANCH_NE_IMM':'BranchImm','BRANCH_LT_U_IMM':'BranchImm','BRANCH_LE_U_IMM':'BranchImm','BRANCH_GE_U_IMM':'BranchImm','BRANCH_GT_U_IMM':'BranchImm','BRANCH_LT_S_IMM':'BranchImm','BRANCH_LE_S_IMM':'BranchImm','BRANCH_GE_S_IMM':'BranchImm','BRANCH_GT_S_IMM':'BranchImm','BRANCH_EQ':'CompareBranch','BRANCH_NE':'CompareBranch','BRANCH_LT_U':'CompareBranch','BRANCH_LT_S':'CompareBranch','BRANCH_GE_U':'CompareBranch','BRANCH_GE_S':'CompareBranch','LOAD_IMM_64':'LoadImm64','STORE_IMM_U8':'StoreImmGeneric','STORE_IMM_U16':'StoreImmGeneric','STORE_IMM_U32':'StoreImmGeneric','STORE_IMM_U64':'StoreImmU64','LOAD_IMM':'LoadImm32','LOAD_U8':'LoadWithBase','LOAD_I8':'LoadWithBase','LOAD_U16':'LoadWithBase','LOAD_I16':'LoadWithBase','LOAD_U32':'LoadWithBase','LOAD_I32':'LoadWithBase','LOAD_U64':'LoadWithBase','STORE_U8':'StoreWithBase','STORE_U16':'StoreWithBase','STORE_U32':'StoreWithBase','STORE_U64':'StoreWithBase','STORE_IMM_IND_U8':'StoreImmIndU8','STORE_IMM_IND_U16':'StoreImmIndU16','STORE_IMM_IND_U32':'StoreImmIndU32','STORE_IMM_IND_U64':'StoreImmIndU64','MOVE_REG':'MoveReg','COUNT_SET_BITS_64':'BitCount64','COUNT_SET_BITS_32':'BitCount32','LEADING_ZERO_BITS_64':'LeadingZeros64','LEADING_ZERO_BITS_32':'LeadingZeros32','TRAILING_ZERO_BITS_64':'TrailingZeros64','TRAILING_ZERO_BITS_32':'TrailingZeros32','SIGN_EXTEND_8':'SignExtend8','SIGN_EXTEND_16':'SignExtend16','ZERO_EXTEND_16':'ZeroExtend16','REVERSE_BYTES':'ReverseBytes64','STORE_IND_U8':'StoreIndirect','STORE_IND_U16':'StoreIndirect','STORE_IND_U32':'StoreIndirect','STORE_IND_U64':'StoreIndirect','LOAD_IND_U8':'LoadInd','LOAD_IND_I8':'LoadIndSignExtend','LOAD_IND_U16':'LoadInd','LOAD_IND_I16':'LoadIndSignExtend','LOAD_IND_U32':'LoadInd','LOAD_IND_I32':'LoadIndSignExtend','LOAD_IND_U64':'LoadInd','ADD_IMM_32':'BinaryImm32','AND_IMM':'ImmBinaryOp64','XOR_IMM':'ImmBinaryOp64','OR_IMM':'ImmBinaryOp64','MUL_IMM_32':'ImmMulOp32','SET_LT_U_IMM':'ImmSetCondOp32New','SET_LT_S_IMM':'ImmSetCondOp32New','SET_GT_U_IMM':'ImmSetCondOp32New','SET_GT_S_IMM':'ImmSetCondOp32New','SHLO_L_IMM_32':'ImmShiftOp32SHLO','SHLO_R_IMM_32':'ImmShiftOp32','SHLO_L_IMM_ALT_32':'ImmShiftOp32Alt','SHLO_R_IMM_ALT_32':'ImmShiftOp32','SHAR_R_IMM_ALT_32':'ImmShiftOp32','NEG_ADD_IMM_32':'NegAddImm32','CMOV_IZ_IMM':'CmovImm','CMOV_NZ_IMM':'CmovImm','ADD_IMM_64':'ImmBinaryOp64','MUL_IMM_64':'ImmMulOp64','SHLO_L_IMM_64':'ImmShiftOp64','SHLO_R_IMM_64':'ImmShiftOp64','SHAR_R_IMM_32':'ImmShiftOp32','SHAR_R_IMM_64':'ImmShiftOp64','NEG_ADD_IMM_64':'NegAddImm64','SHLO_L_IMM_ALT_64':'ImmShiftOp64Alt','SHLO_R_IMM_ALT_64':'ImmShiftOp64Alt','SHAR_R_IMM_ALT_64':'ImmShiftOp64Alt','ROT_R_64_IMM':'ImmShiftOp64','ROT_R_64_IMM_ALT':'ImmShiftOp64','ROT_R_32_IMM_ALT':'ImmShiftOp32','ROT_R_32_IMM':'RotateRight32Imm','ADD_32':'BinaryOp32','SUB_32':'BinaryOp32','MUL_32':'Mul32','DIV_U_32':'DivUOp32','DIV_S_32':'DivSOp32','REM_U_32':'RemUOp32','REM_S_32':'RemSOp32','SHLO_L_32':'SHLO_L_32','SHLO_R_32':'SHLO_R_32','SHAR_R_32':'ShiftOp32SHAR','ADD_64':'BinaryOp64','SUB_64':'BinaryOp64','MUL_64':'Mul64','DIV_U_64':'DivUOp64','DIV_S_64':'DivSOp64','REM_U_64':'RemUOp64','REM_S_64':'RemSOp64','SHLO_L_64':'ShiftOp64','SHLO_R_64':'ShiftOp64B','SHAR_R_64':'ShiftOp64','AND':'BinaryOp64','XOR':'BinaryOp64','OR':'BinaryOp64','MUL_UPPER_S_S':'MulUpperOp64','MUL_UPPER_U_U':'MulUpperOp64','MUL_UPPER_S_U':'MulUpperOp64','SET_LT_U':'SetCondOp64','SET_LT_S':'SetCondOp64','CMOV_IZ':'CmovOp64','CMOV_NZ':'CmovOp64','ROT_L_64':'ShiftOp64','ROT_L_32':'ShiftOp32','ROT_R_64':'ShiftOp64','ROT_R_32':'ShiftOp32','AND_INV':'AndInvOp64','OR_INV':'OrInvOp64','XNOR':'XnorOp64','MAX':'Max','MAX_U':'MinOrMaxU','MIN':'Min','MIN_U':'MinU'};

            // --- BUSINESS LOGIC ---
            const processData = (jsonString) => {
                try {
                    const data = JSON.parse(jsonString);
                    if (typeof data !== 'object' || data === null || Array.isArray(data)) {
                        throw new Error("Input data must be a single JSON object.");
                    }
                    
                    const entries = Object.entries(data);

                    const totalWeightedX86 = entries.reduce((sum, [key, value]) => {
                        return sum + (Number(value.weighted_x86_insts) || 0);
                    }, 0);

                    allData = entries.map(([key, value]) => {
                        const pvmOp = value.pvm_op || key;
                        const totalPvmInsts = Number(value.total_pvm_insts) || 0;
                        const totalX86Insts = Number(value.total_x86_insts) || 0;
                        const weightedX86Insts = Number(value.weighted_x86_insts) || 0;
                        const executionCount = Number(value.execution_count) || 0;
                        
                        return {
                            pvmOp,
                            opcodeValue: pvmOpToOpcodeMap[pvmOp] ?? 'N/A',
                            family: pvmOpToFamilyMap[pvmOp] || 'Unknown',
                            totalPvmInsts,
                            totalX86Insts,
                            executionCount,
                            avgX86InstsPerPvm: totalPvmInsts > 0 ? totalX86Insts / totalPvmInsts : 0,
                            weightedX86Insts,
                            weightPercentage: totalWeightedX86 > 0 ? (weightedX86Insts / totalWeightedX86) * 100 : 0,
                            x86Map: value.x86_map || {}
                        };
                    });

                    localStorage.setItem('pvm-analysis-data', jsonString);
                    return { success: true };
                } catch (e) {
                    console.error("Data processing error:", e);
                    return { success: false, message: e.message };
                }
            };

            // --- RENDERING & DISPLAY LOGIC ---
            const renderAll = () => {
                filterAndSort();
                updateUI();
            };

            const filterAndSort = () => {
                const searchTerm = dom.searchPVM.value.toLowerCase();
                const minCount = parseInt(dom.filterPVMCount.value, 10) || 0;

                displayedData = allData.filter(item => {
                    const searchMatch = item.pvmOp.toLowerCase().includes(searchTerm) || item.family.toLowerCase().includes(searchTerm);
                    const countMatch = item.totalPvmInsts >= minCount;
                    return searchMatch && countMatch;
                });
            };

            const updateUI = () => {
                renderSummary();
                renderBarCharts();
                renderTable();
                updateSortHeaders();
            };
            
            const renderSummary = () => {
                const totalPVM = allData.reduce((sum, d) => sum + d.totalPvmInsts, 0);
                const totalX86 = allData.reduce((sum, d) => sum + d.totalX86Insts, 0);
                const avgRatio = totalPVM > 0 ? (totalX86 / totalPVM).toFixed(3) : '0.000';
                
                dom.summarySection.innerHTML = `
                    <div class="summary-card"><h3>Total PVM Insts</h3><p>${totalPVM.toLocaleString()}</p></div>
                    <div class="summary-card"><h3>Total x86 Insts</h3><p>${totalX86.toLocaleString()}</p></div>
                    <div class="summary-card" style="border-left-color: #f59e0b;"><h3>Overall Avg. Ratio</h3><p>${avgRatio}</p></div>
                    <div class="summary-card" style="border-left-color: #10b981;"><h3>Unique PVM Ops</h3><p>${allData.length}</p></div>
                `;
            };

            const getGroupedData = (data) => {
                const families = data.reduce((acc, item) => {
                    if (!acc[item.family]) {
                        acc[item.family] = {
                            family: item.family,
                            executionCount: 0,
                            totalPvmInsts: 0,
                            totalX86Insts: 0,
                            weightedX86Insts: 0,
                            members: []
                        };
                    }
                    const family = acc[item.family];
                    family.executionCount += item.executionCount;
                    family.totalPvmInsts += item.totalPvmInsts;
                    family.totalX86Insts += item.totalX86Insts;
                    family.weightedX86Insts += item.weightedX86Insts;
                    family.members.push(item);
                    return acc;
                }, {});

                return Object.values(families).map(family => {
                    const totalWeightedX86 = allData.reduce((sum, d) => sum + d.weightedX86Insts, 0);
                    family.avgX86InstsPerPvm = family.totalPvmInsts > 0 ? family.totalX86Insts / family.totalPvmInsts : 0;
                    family.weightPercentage = totalWeightedX86 > 0 ? (family.weightedX86Insts / totalWeightedX86) * 100 : 0;
                    family.pvmOp = family.family; 
                    family.opcodeValue = 'N/A';
                    return family;
                });
            };

            const renderBarCharts = () => {
                let dataForCharts = displayedData;
                let xKey = 'pvmOp';

                if (isGroupedByFamily) {
                    dataForCharts = getGroupedData(displayedData);
                    xKey = 'family';
                }

                dom.chartSection.innerHTML = `
                    <div class="chart-card"><h3>Top 10 by Instruction Count</h3><div id="pvmBarChart" class="bar-chart"></div></div>
                    <div class="chart-card"><h3>Top 10 by Weighted x86 Cost</h3><div id="x86BarChart" class="bar-chart"></div></div>
                `;
                
                const topPVMData = [...dataForCharts].sort((a, b) => b.totalPvmInsts - a.totalPvmInsts).slice(0, 10);
                const topX86Data = [...dataForCharts].sort((a, b) => b.weightedX86Insts - a.weightedX86Insts).slice(0, 10);

                createBarChart("#pvmBarChart", topPVMData, xKey, "totalPvmInsts", "#3b82f6");
                createBarChart("#x86BarChart", topX86Data, xKey, "weightedX86Insts", "#ef4444");
            };
            
            const createBarChart = (selector, data, xKey, yKey, color) => {
                const parent = document.querySelector(selector);
                if (!parent || data.length === 0) return;
                
                d3.select(selector).select("svg").remove();

                const margin = { top: 20, right: 20, bottom: 120, left: 80 };
                const width = parent.clientWidth - margin.left - margin.right;
                const height = 400 - margin.top - margin.bottom;

                const svg = d3.select(selector).append("svg")
                    .attr("width", width + margin.left + margin.right)
                    .attr("height", height + margin.top + margin.bottom)
                    .append("g")
                    .attr("transform", `translate(${margin.left},${margin.top})`);

                const x = d3.scaleBand().range([0, width]).padding(0.1).domain(data.map(d => d[xKey]));
                const y = d3.scaleLinear().range([height, 0]).domain([0, d3.max(data, d => d[yKey])]);

                svg.append("g").attr("class", "axis-x")
                    .attr("transform", `translate(0,${height})`).call(d3.axisBottom(x))
                    .selectAll("text").attr("transform", "translate(-10,0)rotate(-45)").style("text-anchor", "end");

                svg.append("g").attr("class", "axis-y").call(d3.axisLeft(y).ticks(5).tickFormat(d3.format(".2s")));

                svg.selectAll(".bar").data(data).enter().append("rect")
                    .attr("class", "bar")
                    .attr("x", d => x(d[xKey]))
                    .attr("width", x.bandwidth())
                    .attr("y", d => y(d[yKey]))
                    .attr("height", d => height - y(d[yKey]))
                    .attr("fill", color);
            };
            
            const getFormattedValues = (item, parentItem = null) => {
                const formatNormalized = (num) => num % 1 === 0 ? num.toString() : parseFloat(num.toFixed(5)).toString();
                
                const mainRowDivisorItem = isGroupedByFamily ? (parentItem || item) : item;
                const mainRowDivisor = mainRowDivisorItem[normalizationFactor] || 0;
                const normalizeMainRowValue = (val) => (mainRowDivisor > 0 ? val / mainRowDivisor : 0);

                return {
                    execCountStr: (isNormalized && normalizationFactor === 'executionCount') 
                        ? formatNormalized(normalizeMainRowValue(item.executionCount)) 
                        : item.executionCount.toLocaleString(),
                        
                    pvmInstsStr: (isNormalized && normalizationFactor === 'totalPvmInsts')
                        ? formatNormalized(normalizeMainRowValue(item.totalPvmInsts)) 
                        : item.totalPvmInsts.toLocaleString(),

                    x86InstsStr: (isNormalized && normalizationFactor === 'totalPvmInsts')
                        ? formatNormalized(normalizeMainRowValue(item.totalX86Insts)) 
                        : item.totalX86Insts.toLocaleString(),

                    avgInstsPerOpStr: item.avgX86InstsPerPvm.toFixed(3),
                    weightedX86Str: Math.round(item.weightedX86Insts).toLocaleString(),
                    weightPctStr: item.weightPercentage.toFixed(2),
                    x86Map: item.x86Map ? Object.entries(item.x86Map).sort(([,a],[,b]) => b.count - a.count).map(([key, detail]) => {
                        const count = detail.count || 0;
                        let normalizedCount = count;

                        if (isNormalized) {
                            if (normalizationFactor === 'executionCount') {
                                const divisor = item.totalPvmInsts || 0;
                                normalizedCount = divisor > 0 ? count / divisor : 0;
                            } else if (normalizationFactor === 'totalPvmInsts') {
                                const divisor = item.totalX86Insts || 0;
                                normalizedCount = divisor > 0 ? count / divisor : 0;
                            }
                        }
                        
                        return {
                            op: detail.x86_op || 'N/A',
                            countStr: isNormalized ? formatNormalized(normalizedCount) : count.toLocaleString()
                        };
                    }) : []
                };
            };

            const renderTable = () => {
                renderTableHeader();
                let dataToRender = [...displayedData];
                
                if (isGroupedByFamily) {
                    dataToRender = getGroupedData(displayedData);
                }
                
                dataToRender.sort((a, b) => {
                    const col = currentSort.column;
                    const dir = currentSort.direction === 'asc' ? 1 : -1;
                    const valA = a[col];
                    const valB = b[col];
                    if (typeof valA === 'string') return valA.localeCompare(valB) * dir;
                    return (valA - valB) * dir;
                });

                if (dataToRender.length === 0) {
                    dom.tableEmptyState.classList.remove('hidden');
                    dom.tableBody.innerHTML = '';
                    return;
                }
                dom.tableEmptyState.classList.add('hidden');

                let tableHTML = '';
                
                dataToRender.forEach((item, index) => {
                    const rowClass = index % 2 !== 0 ? 'striped-row' : '';
                    if (isGroupedByFamily) {
                        const family = item;
                        const isFamilyExpanded = expandedRows.has(`family:${family.family}`);
                        const familyValues = getFormattedValues(family);

                        tableHTML += `
                            <tr class="family-row ${rowClass}" data-family="${family.family}">
                                <td><span class="toggle-icon">${isFamilyExpanded ? '−' : '+'}</span>${family.family}</td><td></td><td></td>
                                <td>${familyValues.execCountStr}</td>
                                <td>${familyValues.pvmInstsStr}</td>
                                <td>${familyValues.x86InstsStr}</td>
                                <td>${familyValues.avgInstsPerOpStr}</td>
                                <td>${familyValues.weightedX86Str}</td>
                                <td>${familyValues.weightPctStr}%</td>
                            </tr>
                        `;
                        family.members.sort((a, b) => b.weightedX86Insts - a.weightedX86Insts).forEach(member => {
                            const isPvmOpExpanded = expandedRows.has(`pvm:${member.pvmOp}`);
                            const memberValues = getFormattedValues(member, family);
                            
                            tableHTML += `
                                <tr class="pvm-sub-row ${isFamilyExpanded ? '' : 'hidden'}" data-parent-family="${family.family}" data-op="${member.pvmOp}">
                                    <td></td><td>${member.opcodeValue}</td>
                                    <td style="padding-left: 2.5rem;"><span class="toggle-icon">${isPvmOpExpanded ? '−' : '+'}</span>${member.pvmOp}</td>
                                    <td>${memberValues.execCountStr}</td><td>${memberValues.pvmInstsStr}</td><td>${memberValues.x86InstsStr}</td>
                                    <td>${memberValues.avgInstsPerOpStr}</td>
                                    <td>${memberValues.weightedX86Str}</td>
                                    <td>${memberValues.weightPctStr}%</td>
                                </tr>
                            `;
                            memberValues.x86Map.forEach(detail => {
                                tableHTML += `
                                    <tr class="x86-detail-row ${isPvmOpExpanded && isFamilyExpanded ? '' : 'hidden'}" data-parent-op="${member.pvmOp}">
                                        <td colspan="5"></td>
                                        <td style="padding-left: 4.5rem;">↳ ${detail.op}</td>
                                        <td>${detail.countStr}</td>
                                        <td colspan="2"></td>
                                    </tr>
                                `;
                            });
                        });
                    } else { // Individual View
                        const isPvmOpExpanded = expandedRows.has(`pvm:${item.pvmOp}`);
                        const itemValues = getFormattedValues(item);
                        
                        tableHTML += `
                            <tr class="pvm-row ${rowClass}" data-op="${item.pvmOp}">
                                <td>${item.opcodeValue}</td><td>${item.family}</td>
                                <td><span class="toggle-icon">${isPvmOpExpanded ? '−' : '+'}</span>${item.pvmOp}</td>
                                <td>${itemValues.execCountStr}</td><td>${itemValues.pvmInstsStr}</td><td>${itemValues.x86InstsStr}</td>
                                <td>${itemValues.avgInstsPerOpStr}</td>
                                <td>${itemValues.weightedX86Str}</td>
                                <td>${itemValues.weightPctStr}%</td>
                            </tr>
                        `;
                        itemValues.x86Map.forEach(detail => {
                            tableHTML += `
                                <tr class="x86-detail-row ${isPvmOpExpanded ? '' : 'hidden'}" data-parent-op="${item.pvmOp}">
                                    <td colspan="5"></td>
                                    <td style="padding-left: 2.5rem;">↳ ${detail.op}</td>
                                    <td>${detail.countStr}</td>
                                    <td colspan="2"></td>
                                </tr>
                            `;
                        });
                    }
                });
                dom.tableBody.innerHTML = tableHTML;
            };

            const renderTableHeader = () => {
                const headers = isGroupedByFamily 
                ? ['Family', 'Opcode', 'PVM Operation', 'Exec Count', 'Total PVM Insts', 'Total x86 Insts', 'Avg Insts/Op', 'Weighted x86', 'Weight %']
                : ['Opcode', 'Family', 'PVM Operation', 'Exec Count', 'Total PVM Insts', 'Total x86 Insts', 'Avg Insts/Op', 'Weighted x86', 'Weight %'];
                
                const sortKeys = isGroupedByFamily
                ? ['family', 'opcodeValue', 'pvmOp', 'executionCount', 'totalPvmInsts', 'totalX86Insts', 'avgX86InstsPerPvm', 'weightedX86Insts', 'weightPercentage']
                : ['opcodeValue', 'family', 'pvmOp', 'executionCount', 'totalPvmInsts', 'totalX86Insts', 'avgX86InstsPerPvm', 'weightedX86Insts', 'weightPercentage'];

                dom.tableHead.innerHTML = `<tr>${headers.map((h, i) => `<th class="sortable" data-sort-by="${sortKeys[i]}">${h}</th>`).join('')}</tr>`;
            };

            const updateSortHeaders = () => {
                dom.tableHead.querySelectorAll('th').forEach(th => {
                    th.classList.remove('sorted-asc', 'sorted-desc');
                    if (th.dataset.sortBy === currentSort.column) {
                        th.classList.add(`sorted-${currentSort.direction}`);
                    }
                });
            };

            // --- EVENT HANDLERS ---
            const handleFileSelect = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                
                dom.fileNameDisplay.textContent = `Processing: ${file.name}`;
                dom.loadingSpinner.classList.remove('hidden');
                hideError();
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    const result = processData(e.target.result);
                    dom.loadingSpinner.classList.add('hidden');
                    if (result.success) {
                        dom.fileNameDisplay.textContent = `Loaded: ${file.name}`;
                        showAnalysisUI();
                        renderAll();
                    } else {
                        showError(result.message);
                        resetUI();
                    }
                };
                reader.onerror = () => {
                    dom.loadingSpinner.classList.add('hidden');
                    showError("Failed to read the file.");
                    resetUI();
                };
                reader.readAsText(file);
            };

            const handleSort = (event) => {
                const target = event.target.closest('th[data-sort-by]');
                if (!target) return;

                const sortBy = target.dataset.sortBy;
                if (currentSort.column === sortBy) {
                    currentSort.direction = currentSort.direction === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSort.column = sortBy;
                    currentSort.direction = 'desc';
                }
                renderTable();
                updateSortHeaders();
            };

            const handleTableClick = (event) => {
                const toggle = event.target.closest('.toggle-icon');
                if (!toggle) return;

                const parentRow = toggle.closest('tr');
                
                if (parentRow.classList.contains('family-row')) {
                    const familyName = parentRow.dataset.family;
                    const key = `family:${familyName}`;
                    if (expandedRows.has(key)) {
                        expandedRows.delete(key);
                    } else {
                        expandedRows.add(key);
                    }
                    renderTable();
                } else if (parentRow.classList.contains('pvm-sub-row') || parentRow.classList.contains('pvm-row')) {
                    const opName = parentRow.dataset.op;
                    const key = `pvm:${opName}`;
                     if (expandedRows.has(key)) {
                        expandedRows.delete(key);
                    } else {
                        expandedRows.add(key);
                    }
                    renderTable();
                }
            };
            
            const toggleAllDetails = (expand) => {
                if(expand) {
                    let data = isGroupedByFamily ? getGroupedData(displayedData) : displayedData;
                    data.forEach(item => {
                        if(isGroupedByFamily) {
                            expandedRows.add(`family:${item.family}`);
                            item.members.forEach(member => expandedRows.add(`pvm:${member.pvmOp}`));
                        } else {
                            expandedRows.add(`pvm:${item.pvmOp}`);
                        }
                    });
                } else {
                    expandedRows.clear();
                }
                renderTable();
            };

            const handleClearData = () => {
                localStorage.removeItem('pvm-analysis-data');
                resetUI();
            };

            const handleNormalizeToggle = () => {
                isNormalized = !isNormalized;
                dom.normalizeButton.textContent = isNormalized ? 'Denormalize' : 'Normalize';
                dom.normalizeButton.classList.toggle('active', isNormalized);
                dom.normalizationControls.classList.toggle('hidden', !isNormalized);
                renderTable();
            };

            const handleGroupByFamilyToggle = () => {
                isGroupedByFamily = !isGroupedByFamily;
                dom.groupByFamilyButton.textContent = isGroupedByFamily ? 'Ungroup' : 'Group by Family';
                dom.groupByFamilyButton.classList.toggle('active', isGroupedByFamily);
                expandedRows.clear(); 
                currentSort.column = isGroupedByFamily ? 'weightedX86Insts' : 'weightedX86Insts';
                currentSort.direction = 'desc';
                renderAll();
            };

            const handleNormalizationFactorChange = (event) => {
                normalizationFactor = event.target.value;
                if (isNormalized) {
                    renderTable();
                }
            };

            // --- UI STATE CHANGERS ---
            const showAnalysisUI = () => {
                dom.analysisSection.classList.remove('hidden');
                dom.resultsSection.classList.remove('hidden');
                dom.clearDataButton.classList.remove('hidden');
                hideError();
            };
            
            const resetUI = () => {
                dom.analysisSection.classList.add('hidden');
                dom.resultsSection.classList.add('hidden');
                dom.clearDataButton.classList.add('hidden');
                dom.fileNameDisplay.textContent = '';
                dom.jsonFile.value = '';
                allData = [];
                displayedData = [];
                expandedRows.clear();
                dom.searchPVM.value = '';
                dom.filterPVMCount.value = '';
                dom.chartSection.innerHTML = '';
                dom.tableBody.innerHTML = '';
                dom.summarySection.innerHTML = '';
            };

            const showError = (message) => {
                dom.errorMessage.textContent = message;
                dom.errorMessage.classList.remove('hidden');
            };

            const hideError = () => {
                dom.errorMessage.classList.add('hidden');
            }
            
            const showModalError = (message) => {
                dom.modalErrorMessage.textContent = message;
                dom.modalErrorMessage.classList.remove('hidden');
            }

            const hideModalError = () => {
                dom.modalErrorMessage.classList.add('hidden');
            }

            // --- EXPORTERS ---
            const exportToCsv = () => {
                // This function needs to be adapted for grouped view if desired
                const headers = ['Opcode', 'Family', 'PVM Operation', 'Execution Count', 'Total PVM Insts', 'Total x86 Insts', 'Avg Insts/Op', 'Weighted x86', 'Weight %'];
                let csvContent = headers.join(',') + '\n';
                
                displayedData.forEach(item => {
                    const row = [
                        item.opcodeValue, 
                        item.family,
                        item.pvmOp, 
                        item.executionCount,
                        item.totalPvmInsts, 
                        item.totalX86Insts, 
                        item.avgX86InstsPerPvm.toFixed(3),
                        Math.round(item.weightedX86Insts),
                        item.weightPercentage.toFixed(2)
                    ];
                    csvContent += row.map(val => `"${String(val).replace(/"/g, '""')}"`).join(',') + '\n';
                });

                downloadFile(csvContent, 'pvm_analysis.csv', 'text/csv;charset=utf-8;');
            };
            
            const exportToJson = () => {
                downloadFile(JSON.stringify(displayedData, null, 2), 'pvm_analysis.json', 'application/json');
            };

            const downloadFile = (content, fileName, mimeType) => {
                const blob = new Blob([content], { type: mimeType });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
            };

            // --- INITIAL SETUP AND EVENT LISTENERS ---
            const init = () => {
                dom.jsonFile.addEventListener('change', handleFileSelect);
                dom.searchPVM.addEventListener('input', renderAll);
                dom.filterPVMCount.addEventListener('input', renderAll);
                
                dom.clearDataButton.addEventListener('click', handleClearData);
                dom.clearFilters.addEventListener('click', () => {
                    dom.searchPVM.value = '';
                    dom.filterPVMCount.value = '';
                    renderAll();
                });
                dom.exportCsv.addEventListener('click', exportToCsv);
                dom.exportJson.addEventListener('click', exportToJson);
                dom.expandAll.addEventListener('click', () => toggleAllDetails(true));
                dom.collapseAll.addEventListener('click', () => toggleAllDetails(false));
                dom.normalizeButton.addEventListener('click', handleNormalizeToggle);
                dom.groupByFamilyButton.addEventListener('click', handleGroupByFamilyToggle);
                dom.normalizationFactorSelect.addEventListener('change', handleNormalizationFactorChange);
                
                dom.tableHead.addEventListener('click', handleSort);
                dom.tableBody.addEventListener('click', handleTableClick);

                dom.pasteJsonButton.addEventListener('click', () => {
                    hideModalError();
                    dom.jsonModal.classList.remove('hidden');
                    dom.jsonPasteArea.focus();
                });
                dom.closeModal.addEventListener('click', () => dom.jsonModal.classList.add('hidden'));
                dom.processPastedJson.addEventListener('click', () => {
                    const jsonText = dom.jsonPasteArea.value;
                    if (!jsonText) {
                        showModalError("Paste area is empty.");
                        return;
                    }
                    const result = processData(jsonText);
                    if (result.success) {
                        dom.jsonModal.classList.add('hidden');
                        dom.fileNameDisplay.textContent = 'Loaded from pasted data.';
                        showAnalysisUI();
                        renderAll();
                    } else {
                        showModalError(result.message);
                    }
                });

                const savedData = localStorage.getItem('pvm-analysis-data');
                if (savedData) {
                    const result = processData(savedData);
                    if (result.success) {
                        dom.fileNameDisplay.textContent = 'Loaded from previous session.';
                        showAnalysisUI();
                        renderAll();
                    } else {
                        localStorage.removeItem('pvm-analysis-data');
                    }
                } else {
                    renderTableHeader(); // Render initial header
                }
            };

            init();
        });
    </script>
</body>
</html>
