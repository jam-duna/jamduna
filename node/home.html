<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Recent Blocks</title>
    <style>
        body {
            font-size: 10px;
            font-family: Arial;
        }

        table,
        th,
        td {
            border: 0px solid black;
            border-collapse: collapse;
            padding: 0px;
        }

        .extrinsicCount {
            font-size: 10px;
            display: block;
        }

        .numtickets {
            color: red;
        }

        .numpreimagelookups {
            color: blue;
        }

        .numguarantees {
            color: green;
        }

        .numassurances {
            color: orange;
        }

        .numdisputes {
            color: purple;
        }

        .epochmark {
            color: #FF69B4;
        }

        /* HotPink */
        .winningticketsmark {
            color: #00FFFF;
        }

        /* Aqua */
        .verdictmarkers {
            color: #FFD700;
        }

        /* Gold */
        .offendermarkers {
            color: #FF4500;
        }

        /* OrangeRed */
        .details-container {
            margin-top: 20px;
        }

        pre {
            background-color: #f4f4f4;
            padding: 1px;
            overflow: auto;
            max-height: 500px;
        }

        .link-button {
            margin-right: 5px;
            text-decoration: underline;
            color: blue;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <table border=0 width="100%">
        <tr>
            <td width="15%"><img src="https://i.ibb.co/PCCmkxg/image.png" height="100" /></td>
            <td width="85%" align="left">
                <font size="+2">Colorful Notion JAM Block Explorer</font>
            </td>
        </tr>
    </table>
    <table id="blocksTable">
        <tr id="server0"></tr>
        <tr id="server1"></tr>
        <tr id="server2"></tr>
        <tr id="server3"></tr>
        <tr id="server4"></tr>
        <tr id="server5"></tr>
    </table>

    <div class="details-container">
        <div id="details">Click a block hash to see details</div>
    </div>


    <script>
        var baseURL = `http://karura-internal.polkaholic.io`;
        const servers = [0, 1, 2, 3, 4, 5];

        function fetchRecentBlocks(serverIndex) {
            fetch(`${baseURL}:${9900 + serverIndex}/recentblocks`)
                .then(response => response.json())
                .then(blocks => {
                    let blockRow = document.getElementById(`server${serverIndex}`);
                    blockRow.innerHTML = '';
                    blocks.forEach(block => {
                        let parentHash = block.header.parent_hash;
                        let blockHash = block.block_hash;
                        let color = blockHash.slice(2, 8); // Use first 6 hex digits after '0x'
                        let blockAuthorKey = block.header.block_author_key;
                        let truncatedBlockHash = blockHash.slice(2, 8); // First 6 digits of blockHash

                        let extrinsicCounts = '';
                        let extrinsicData = block.extrinsic;

                        if (extrinsicData.tickets && extrinsicData.tickets.length > 0) extrinsicCounts += `<span class="extrinsicCount numtickets">t:${extrinsicData.tickets.length}</span>`;
                        if (extrinsicData.preimage_lookups && extrinsicData.preimage_lookups.length > 0) extrinsicCounts += `<span class="extrinsicCount numpreimagelookups">p:${extrinsicData.preimage_lookups.length}</span>`;
                        if (extrinsicData.guarantees && extrinsicData.guarantees.length > 0) extrinsicCounts += `<span class="extrinsicCount numguarantees">g:${extrinsicData.guarantees.length}</span>`;
                        if (extrinsicData.assurances && extrinsicData.assurances.length > 0) extrinsicCounts += `<span class="extrinsicCount numassurances">a:${extrinsicData.assurances.length}</span>`;
                        if (extrinsicData.disputes && extrinsicData.disputes.length > 0) extrinsicCounts += `<span class="extrinsicCount numdisputes">d:${extrinsicData.disputes.length}</span>`;

                        let headerIndicators = '';
                        if (block.header.epoch_mark) headerIndicators += `<span class="extrinsicCount epochmark">EM</span>`;
                        if (block.header.winning_tickets_mark && block.header.winning_tickets_mark.length > 0) headerIndicators += `<span class="extrinsicCount winningticketsmark">WT</span>`;
                        if (block.header.verdict_markers) headerIndicators += `<span class="extrinsicCount verdictmarkers">V</span>`;
                        if (block.header.offender_markers) headerIndicators += `<span class="extrinsicCount offendermarkers">O</span>`;

                        let td = document.createElement('td');
                        td.innerHTML = `
                            <div style="background-color: #${color}; padding: 5px; margin: 2px;">
                                <div>
                                    <span class="link-button" onclick="showBlockDetails(${serverIndex}, '${blockHash}')">
                                        ${blockAuthorKey}-${truncatedBlockHash}
                                    </span><span class="link-button" onclick="showJamState(${serverIndex}, '${blockHash}')">
                                        State
                                    </span>
                                </div>
                                ${extrinsicCounts}
                                ${headerIndicators}
                            </div>
                        `;
                        blockRow.appendChild(td);
                    });
                })
                .catch(error => console.error('Error fetching recent blocks:', error));
        }

        function showBlockDetails(serverIndex, blockHash) {
            fetch(`${baseURL}:${9900 + serverIndex}/block/${blockHash}`)
                .then(response => response.json())
                .then(block => {
                    let detailsTable = `<h2>Block Details</h2> <table>`;

                    // BlockHeader fields
                    const header = block.header;
                    detailsTable += createTableRow('BlockHash', blockHash);
                    detailsTable += createTableRow('ParentHash', header.parent_hash);
                    detailsTable += createTableRow('PriorStateRoot', header.prior_state_root);
                    detailsTable += createTableRow('ExtrinsicHash', header.extrinsic_hash);
                    detailsTable += createTableRow('TimeSlot', header.timeslot + ' ' + formatTimestamp(header.timeslot));
                    detailsTable += createTableRow('EpochMark', header.epoch_mark || 'None');
                    detailsTable += createTableRow('WinningTicketsMark', header.winning_tickets_mark && header.winning_tickets_mark.length > 0 ? JSON.stringify(header.winning_tickets_mark, null, 2) : 'None');
                    detailsTable += createTableRow('VerdictMarkers', header.verdict_markers || 'None');
                    detailsTable += createTableRow('OffenderMarkers', header.offender_markers || 'None');
                    detailsTable += createTableRow('BlockAuthorKey', header.block_author_key);
                    detailsTable += createTableRow('VRFSignature', header.vrf_signature || 'None');
                    detailsTable += createTableRow('BlockSeal', header.block_seal || 'None');

                    // ExtrinsicData counts
                    const extrinsic = block.extrinsic;
                    if (extrinsic.tickets) detailsTable += createTableRow('Tickets', extrinsic.tickets.length);
                    if (extrinsic.preimage_lookups) detailsTable += createTableRow('PreimageLookups', extrinsic.preimage_lookups.length);
                    if (extrinsic.guarantees) detailsTable += createTableRow('Guarantees', extrinsic.guarantees.length);
                    if (extrinsic.assurances) detailsTable += createTableRow('Assurances', extrinsic.assurances.length);
                    if (extrinsic.disputes) detailsTable += createTableRow('Disputes', extrinsic.disputes.length);
                    detailsTable += `</table>`;

                    document.getElementById('details').innerHTML = detailsTable;
                })
                .catch(error => console.error('Error fetching block details:', error));
        }

        function showJamState(serverIndex, blockHash) {
            fetch(`${baseURL}:${9900 + serverIndex}/jamstate/${blockHash}`)
                .then(response => response.json())
                .then(jamState => {
                    let detailsTable = `<h2>State Details</h2> <table>`;
                    detailsTable += createTableRow('BlockHash', blockHash);
                    detailsTable += createTableRow('SafroleStateGamma', formatJSON(jamState.safrole_state_gamma));
                    detailsTable += createTableRow('SafroleState', formatJSON(jamState.safrole_state) || 'None');
                    detailsTable += createTableRow('AvailabilityAssignments', formatJSON(jamState.availability_assignments));
                    detailsTable += createTableRow('ValidatorStatistics', formatJSON(jamState.validator_statistics));
                    detailsTable += createTableRow('DisputesState', formatJSON(jamState.disputes_state));
                    detailsTable += createTableRow('AuthorizationsPool', formatJSON(jamState.authorizations_pool));
                    detailsTable += createTableRow('AuthorizationQueue', formatJSON(jamState.authorization_queue));
                    detailsTable += createTableRow('RecentBlocks', formatJSON(jamState.beefy_pool));
                    detailsTable += createTableRow('PrivilegedServiceIndices', formatJSON(jamState.privileged_services_indices));
                    detailsTable += `</table>`;

                    document.getElementById('details').innerHTML = detailsTable;
                })
                .catch(error => console.error('Error fetching JamState details:', error));
        }

        function createTableRow(label, content) {
            return `
                <tr>
                    <th>${label}</th>
                    <td><pre>${content}</pre></td>
                </tr>
            `;
        }

        function formatJSON(jsonData) {
            return JSON.stringify(jsonData, null, 2);
        }

        function refreshBlocks() {
            servers.forEach(serverIndex => fetchRecentBlocks(serverIndex));
        }

        function formatTimestamp(unixTimestamp) {
            const now = Math.floor(Date.now() / 1000); // Current time in seconds
            const secondsAgo = now - unixTimestamp;
            const date = new Date(unixTimestamp * 1000); // Convert Unix timestamp to milliseconds
            const hours = String(date.getUTCHours()).padStart(2, '0');
            const minutes = String(date.getUTCMinutes()).padStart(2, '0');
            const seconds = String(date.getUTCSeconds()).padStart(2, '0');

            return `${hours}:${minutes}:${seconds} (${secondsAgo}s ago)`;
        }

        // Initial load and interval refresh
        refreshBlocks();
        setInterval(refreshBlocks, 2000);
    </script>
</body>

</html>