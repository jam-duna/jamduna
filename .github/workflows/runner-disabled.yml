name: Jam Runner main

env:
  GOFLAGS: "-tags=tiny"
  JAM_PATH: ${{ github.workspace }}
  LD_LIBRARY_PATH: ./bls/target/release:./bandersnatch/target/release
  CARGO_MANIFEST_DIR: ${{ github.workspace }}

on:
  push:
    branches:
      - main
    paths:
      - .github/workflows/runner.yml
      - statedb/*.go
      - pvm/*.go
      - statedb/*.go
      - node/*.go
  schedule:
    - cron: '10 * * * *'
      branches:
        - main

jobs:
  test:
    runs-on: polkavm
    timeout-minutes: 50
    strategy:
      max-parallel: 2
    steps:
      - name: Checkout main code
        uses: actions/checkout@v3
        with: { ref: main }

      - name: Add Go to PATH
        run: echo "/usr/local/go/bin" >> $GITHUB_PATH
          
      - name: Verify Go version
        run: go version

      - name: Set environment variables
        run: |
          echo "/usr/local/go/bin" >> $GITHUB_PATH      
          echo "GOFLAGS=\"-tags=tiny\"" >> $GITHUB_ENV
          echo "JAM_PATH=${{ github.workspace }}" >> $GITHUB_ENV
          echo "LD_LIBRARY_PATH=./bls/target/release: ./bandersnatch/target/release" >> $GITHUB_ENV
          echo "CARGO_MANIFEST_DIR=${{ github.workspace }}" >> $GITHUB_ENV

      - name: Clear Go module cache
        run: go clean -modcache

      - name: Cache Go modules
        uses: actions/cache@v3
        with:
          path: ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      - name: Install Go dependencies
        run: go mod tidy

      - name: Build Algo_Node_Compiler
        working-directory: ./node
        run: make algo_node_compiler

      - name: Build Algo_Node_Compiler
        working-directory: ./node
        run: make algo_node_compiler

      - name: Build Algo_Node_Compiler
        working-directory: ./node
        run: make algo_node_compiler

      - name: Build Algo_Node_Compiler
        working-directory: ./node
        run: make algo_node_compiler

