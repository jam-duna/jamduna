package statedb

import (
	"encoding/json"
	"os"
	"reflect"
	"testing"

	"github.com/colorfulnotion/jam/common"
	"github.com/colorfulnotion/jam/types"
)

func TestC3(t *testing.T) {
	c1 := common.Hex2Bytes("0x0642b16dd0c7aeb5b040b1ae8e54560d6567e628f7548d24a11542b388b6a1987401010000000000000000000000000000000000000000000000000000000000000000aabc18aa2c7b2a729156dbd51fb21a6ccf96982542c346579c2f8738644aec3d00dd5dc3e610dc4a6ea619cd5f3c0372cc519919a5e9fbf5e94a7d58df797c730f020001ad3228b676f7d3cd4284a5443f17f1962b36e491b30a40b2405849e597ba5fb57956ed4f882cc2acf104c6e33d430a06295c018784109609c5c15856f1fef49d00897834e7c40f9f06337d36f7b604aad7b0dfbaab2326af1a27cf3d94333de5190201000000000000000000000000000000000000000000000000000000000000000001ad3228b676f7d3cd4284a5443f17f1962b36e491b30a40b2405849e597ba5fb50702c5368131626841d33d1740ce2bcb815b350d0537a22a64113d8b6937435b004e703d99aee0c938d8eefce5121120571bd484a74f4481adb88d4599ee54c7f103000001b4c11951957c6f8f642c4af61cd6b24640fec6dc7fc607ee8206a99e92410d30f63fc0ccf98ef8e644f7725aa31e25ef844035b1e4a9a4d7a31e5c051187805901bee209c1565945f22dbcc151ab09be9b2fe8311cb86dd5482634a8fa947dc360097139d6a96fa0d4402aa89cbde2d8c83a35cfa3ec19e1dbb633b503bf7f0495f4d0be5238ddbbb226d4464bd3b873eae7df08a8d4ed5a8eea0c2a1e6b31aef7030100000000000000000000000000000000000000000000000000000000000000000001b4c11951957c6f8f642c4af61cd6b24640fec6dc7fc607ee8206a99e92410d300448b2afb9a446746f1e2e668882ed92e91508d6d81d786baa515711262b2f5000411899cb3b3526a6a29a15ea5be4a5b8bfa587290645dc9e72111dc65e951670030001ad3228b676f7d3cd4284a5443f17f1962b36e491b30a40b2405849e597ba5fb501b4c11951957c6f8f642c4af61cd6b24640fec6dc7fc607ee8206a99e92410d30000000000000000000000000000000000000000000000000000000000000000000")
	d1, _, err := types.Decode(c1, reflect.TypeOf(RecentBlocks{}))
	if err != nil {
		panic(err)
	}
	dump_recent_blocks("c3", d1.(RecentBlocks))
	c2 := common.Hex2Bytes("0x0642b16dd0c7aeb5b040b1ae8e54560d6567e628f7548d24a11542b388b6a1987401010000000000000000000000000000000000000000000000000000000000000000aabc18aa2c7b2a729156dbd51fb21a6ccf96982542c346579c2f8738644aec3d00dd5dc3e610dc4a6ea619cd5f3c0372cc519919a5e9fbf5e94a7d58df797c730f020001ad3228b676f7d3cd4284a5443f17f1962b36e491b30a40b2405849e597ba5fb57956ed4f882cc2acf104c6e33d430a06295c018784109609c5c15856f1fef49d00897834e7c40f9f06337d36f7b604aad7b0dfbaab2326af1a27cf3d94333de5190201000000000000000000000000000000000000000000000000000000000000000001ad3228b676f7d3cd4284a5443f17f1962b36e491b30a40b2405849e597ba5fb50702c5368131626841d33d1740ce2bcb815b350d0537a22a64113d8b6937435b004e703d99aee0c938d8eefce5121120571bd484a74f4481adb88d4599ee54c7f103000001b4c11951957c6f8f642c4af61cd6b24640fec6dc7fc607ee8206a99e92410d30f63fc0ccf98ef8e644f7725aa31e25ef844035b1e4a9a4d7a31e5c051187805901bee209c1565945f22dbcc151ab09be9b2fe8311cb86dd5482634a8fa947dc360097139d6a96fa0d4402aa89cbde2d8c83a35cfa3ec19e1dbb633b503bf7f0495f4d0be5238ddbbb226d4464bd3b873eae7df08a8d4ed5a8eea0c2a1e6b31aef7030100000000000000000000000000000000000000000000000000000000000000000001b4c11951957c6f8f642c4af61cd6b24640fec6dc7fc607ee8206a99e92410d300448b2afb9a446746f1e2e668882ed92e91508d6d81d786baa515711262b2f5000411899cb3b3526a6a29a15ea5be4a5b8bfa587290645dc9e72111dc65e95167003000136db12701ba186a777e5192ce605b29af2ff5d3e648fbbc4ba81d6594d64fa4a01b4c11951957c6f8f642c4af61cd6b24640fec6dc7fc607ee8206a99e92410d30000000000000000000000000000000000000000000000000000000000000000000")
	d2, _, err := types.Decode(c2, reflect.TypeOf(RecentBlocks{}))
	dump_recent_blocks("c3", d2.(RecentBlocks))
}

func TestStateTransitionCodec(t *testing.T) {
	preStateJsonPath := "testdata/traces/395479_007.json"
	preStateJsonByte, err := os.ReadFile(preStateJsonPath)
	if err != nil {
		t.Fatal(err)
	}

	blockJsonPath := "testdata/blocks/395479_007.json"
	blockJsonByte, err := os.ReadFile(blockJsonPath)
	if err != nil {
		t.Fatal(err)
	}

	postStateJsonPath := "testdata/traces/395479_008.json"
	postStateJsonByte, err := os.ReadFile(postStateJsonPath)
	if err != nil {
		t.Fatal(err)
	}

	// unmarshal the byte to StateSnapshotRaw
	var preState StateSnapshotRaw
	err = json.Unmarshal(preStateJsonByte, &preState)
	if err != nil {
		t.Fatal(err)
	}

	var block types.Block
	err = json.Unmarshal(blockJsonByte, &block)
	if err != nil {
		t.Fatal(err)
	}

	var postState StateSnapshotRaw
	err = json.Unmarshal(postStateJsonByte, &postState)
	if err != nil {
		t.Fatal(err)
	}

	a := StateTransition{
		PreState:  preState,
		Block:     block,
		PostState: postState,
	}
	encoded, err := types.Encode(a)
	if err != nil {
		t.Fatal(err)
	}
	decoded, _, err := types.Decode(encoded, reflect.TypeOf(StateTransition{}))
	if err != nil {
		t.Fatal(err)
	}

	encoded2, err := types.Encode(decoded)
	if err != nil {
		t.Fatal(err)
	}

	if !reflect.DeepEqual(encoded, encoded2) {
		t.Fatal("encoded and encoded2 are not equal")
	}
}
