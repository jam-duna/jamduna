name: Update Rust Nightly

on:
  schedule:
    # Run every Monday at 09:00 UTC
    - cron: "0 9 * * 1"
  workflow_dispatch: # Allow manual trigger

jobs:
  update-rust:
    name: Update Rust Nightly Version
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - uses: actions/checkout@v4

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "24"
          cache: "npm"

      - name: Install npm dependencies
        run: npm ci

      - name: Get latest nightly date
        id: get-nightly
        run: |
          LATEST=$(.github/scripts/get-latest-nightly.sh)
          echo "version=$LATEST" >> "$GITHUB_OUTPUT"
          echo "Latest nightly: $LATEST"

      - name: Get current version
        id: get-current
        run: |
          CURRENT=$(grep -oE 'nightly-[0-9]{4}-[0-9]{2}-[0-9]{2}' \
            rust-toolchain.toml | head -1)
          echo "version=$CURRENT" >> "$GITHUB_OUTPUT"
          echo "Current nightly: $CURRENT"

      - name: Update version in files
        if: steps.get-nightly.outputs.version != steps.get-current.outputs.version
        run: |
          .github/scripts/update-rust-version.sh "${{ steps.get-nightly.outputs.version }}"

      - name: Run prettier
        if: steps.get-nightly.outputs.version != steps.get-current.outputs.version
        run: npx prettier --write "*.md"

      - name: Commit version update
        if: steps.get-nightly.outputs.version != steps.get-current.outputs.version
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add rust-toolchain.toml Makefile .github/workflows/ci.yml
          git commit -m "chore: update Rust nightly to ${{ steps.get-nightly.outputs.version }}"

      - name: Create Pull Request
        id: create-pr
        if: steps.get-nightly.outputs.version != steps.get-current.outputs.version
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.PAT_WORKFLOW }}
          title: "chore: update Rust nightly to ${{ steps.get-nightly.outputs.version }}"
          body: |
            Automated update of Rust nightly version.

            **Changes:**
            - `rust-toolchain.toml`
            - `Makefile`
            - `.github/workflows/ci.yml`
            - `CHANGELOG.md`

            **From:** `${{ steps.get-current.outputs.version }}`
            **To:** `${{ steps.get-nightly.outputs.version }}`

            Please review and ensure CI passes before merging.
          branch: chore/update-rust-${{ steps.get-nightly.outputs.version }}
          base: develop
          delete-branch: true

      - name: Add changelog entry with PR number
        if: steps.create-pr.outputs.pull-request-number
        env:
          PR_NUMBER: ${{ steps.create-pr.outputs.pull-request-number }}
          VERSION: ${{ steps.get-nightly.outputs.version }}
        run: |
          git fetch origin
          git checkout chore/update-rust-$VERSION
          sed -i "/^### Changed$/a\\
          - Update Rust nightly to \`$VERSION\`\\
            ([#$PR_NUMBER](https://github.com/${{ github.repository }}/pull/$PR_NUMBER))" CHANGELOG.md
          npx prettier --write CHANGELOG.md
          git add CHANGELOG.md
          git commit -m "docs: add changelog entry for Rust $VERSION"
          git push origin chore/update-rust-$VERSION
